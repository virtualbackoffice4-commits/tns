<xaiArtifact artifact_id="fcb58878-48b9-4190-82f7-f1933e6d5ef6" artifact_version_id="0a8b3dc0-90dc-4bdf-b631-d53052fe93dc" title="index.html" contentType="text/html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tag Splitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="style.css">
<style>
/* Modal overlay */
.modal-overlay {
  display: none; /* hidden by default */
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
/* Modal box */
.modal-box {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 320px;
  width: 90%;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  animation: fadeIn 0.3s ease-in-out;
}
/* Text */
.modal-message {
  font-size: 16px;
  color: #1f2937; /* dark text */
  margin-bottom: 15px;
}
/* Buttons inside modal */
.modal-actions {
  display: flex;
  justify-content: space-around;
  gap: 10px;
}
.modal-actions .btn {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  border: none;
  font-size: 14px;
  transition: background 0.2s;
}
.modal-actions .btn:hover {
  opacity: 0.9;
}
/* Danger (red) button */
.modal-actions .btn.danger {
  background: #dc2626;
  color: #fff;
}
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(-10px);}
  to {opacity: 1; transform: translateY(0);}
}
 
.btn.danger {
  background-color: #dc2626; /* Red color */
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
.btn.danger:hover {
  background-color: #b91c1c; /* Darker red on hover */
}
 
/* File input custom style with camera icon */
input[type="file"] {
  display: block;
  padding: 8px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background: #f9f9f9 url('https://cdn-icons-png.flaticon.com/512/685/685655.png') no-repeat 10px center;
  background-size: 20px 20px;
  padding-left: 40px;
  cursor: pointer;
  transition: 0.3s ease;
}

input[type="file"].selected {
  border-color: #45b08e;      /* green border */
  background-color: #e6ffed;  /* light green background */
}


  
input[type="file"]:hover {
  border-color: #007bff;
  background-color: #eef6ff;
}
input[type="file"]::-webkit-file-upload-button {
  visibility: hidden;
}
input[type="file"]::before {
  content: "üì∑ Choose Photo";
  display: inline-block;
  background: #007bff;
  color: white;
  padding: 6px 12px;
  border-radius: 5px;
  font-size: 14px;
  margin-right: 10px;
  cursor: pointer;
}
input[type="file"]:hover::before {
  background: #0056b3;
}
</style>
</head>
<body>
  <header>
    <h2 class="page-title">Tag Splitter</h2>
  </header>
  <!-- Sign-in card -->
  <div id="signinCard" class="card">
    <div class="row center">
      <div id="signinBtn"></div>
    </div>
    <div id="accessMsg" class="row muted small-text">
      Please contact Admin if your ID is not registered!
    </div>
    <div id="deniedMsg" class="row error hidden">
      Access denied ‚Äî Contact admin for allowing your mail ID!
    </div>
  </div>
  <!-- Form card -->
  <div id="formCard" class="card hidden">
    <div class="row muted" id="whoami"></div>
  
    <form id="dataForm" class="form">
      <input type="email" name="email" class="hidden" readonly required />
      <input type="hidden" name="startTime" />
<div class="row">
  <select name="windowoption" required>
    <option value="">Select Window</option>
    <option>Merotra</option>
    <option>Sunny</option>
  </select>
</div>
      <div class="form-step">Step 1 - ‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü ‡§ü‡•à‡§ó‡§ø‡§Ç‡§ó ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</div>
      <div id="locationRow" class="row hidden">
        <input type="text" name="locationLink" placeholder="Enter Google Maps Link" />
      </div>
      <button type="button" id="startTaggingBtn" class="btn primary" onclick="startTagging()">Start Tagging</button>
      <div class="form-step">Step 2 - ‡§∏‡•ç‡§™‡•ç‡§≤‡§ø‡§ü‡§∞ ‡§á‡§®‡§™‡•Å‡§ü ‡§§‡•ã‡§°‡§º‡•á‡§Ç(‡§¨‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§®‡§æ ‡§π‡•à ‡§§‡•ã‡§°‡§º‡§®‡§æ ‡§π‡•à)</div>
      <div class="row">
        <select name="splitter" required>
          <option value="">Select Splitter</option>
          <option>2 way</option>
          <option>4 way</option>
          <option>8 way</option>
          <option>Link JC</option>
        </select>
      </div>
      <div class="form-step">Step 3 - ‡§ú‡•á ‡§∏‡•Ä ‡§î‡§∞ ‡§∏‡•ç‡§™‡•ç‡§≤‡§ø‡§ü‡§∞ ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§™‡§æ‡§∏ ‡§∏‡•á</div>
      <div class="row">
        <input type="file" name="photo1" accept="image/*" capture="environment" required />
      </div>
      <div class="form-step">Step 4 - ‡§™‡•ã‡§≤ ‡§î‡§∞ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•Ç‡§∞ ‡§∏‡•á</div>
      <div class="row">
        <input type="file" name="photo2" accept="image/*" capture="environment" required />
      </div>
      <div class="form-step">Step 5 - ‡§≤‡§æ‡§á‡§® ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç</div>
      <div class="row">
        <input type="text" name="jcname" required placeholder="Enter JC Name" />
      </div>
<div class="row">
  <select name="wire" required>
    <option value="">Select Wire</option>
    <option>1 Core</option>
    <option>2 Core</option>
    <option>4 Core</option>
    <option>6 Core</option>
    <option>12 Core</option>
    <option>96 Core</option>
  </select>
</div>
<div class="row">
  <input type="number" name="vacantcores" required placeholder="Enter Vacant Cores" />
</div>
      <div class="row">
        <select name="wirecolor">
          <option value="">Select Wire Color</option>
          <option>Black</option>
          <option>Orange</option>
          <option>Other</option>
        </select>
      </div>
      <div class="row">
        <input type="text" name="linename" placeholder="Line Name (Optional)" />
      </div>
      <div class="row">
        <input type="text" name="drumno" placeholder="Drum No (Optional)" />
      </div>
      <div class="row">
        <textarea name="remark" placeholder="Write remarks..."></textarea>
      </div>
      <div class="form-step">Step 6 - ‡§∏‡•ç‡§™‡•ç‡§≤‡§ø‡§ü‡§∞ ‡§ï‡§æ ‡§á‡§®‡§™‡•Å‡§ü ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ Tagging done ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç
</div>
      <div class="row actions">
        <button type="submit" id="submitBtn" class="btn success" disabled>
          Tagging done <span id="countdown"></span>
        </button>
        <button type="button" id="resetBtn" class="btn danger" onclick="resetTag()">Reset this tag"</button>
        <br>
        <span id="submitStatus" class="muted small-text"></span>
      </div>
    </form>
  </div>
  <!-- Custom Reset Confirmation Modal -->
  <div id="resetModal" class="modal-overlay">
    <div class="modal-box">
      <p class="modal-message">‚ö†Ô∏è Are you sure you want to reset this tag?<br>All unsaved progress will be lost.</p>
      <div class="modal-actions">
        <button id="confirmResetBtn" class="btn danger">Yes, Reset</button>
        <button id="cancelResetBtn" class="btn">Cancel</button>
      </div>
    </div>
  </div>
  <script>
    const allowedEmails = ["shahzebahmad2024@gmail.com", "trustindeal.amanwiz@gmail.com", "alamshan761@gmail.com", "ainulkhan424@gmail.com"];
    const scriptURL = "https://script.google.com/macros/s/AKfycbwMZoKlv8-WD-kwwURqjdTu-L9VW5IZd9Z1NB6_-FW_OCj_fmBYMOTio-vjI7eX-PxX/exec";
    const clientID = "333245582834-m1u6kn51f7cscdkccsbcgfbav0mn5vm1.apps.googleusercontent.com";
    let timerInterval;
    let lastRemaining = null;
    const COUNTDOWN_DURATION = 600; // seconds
    const fieldsToSave = ['windowoption', 'locationLink', 'splitter', 'jcname', 'wire', 'vacantcores', 'wirecolor', 'linename', 'drumno', 'remark'];

    window.onload = () => {
      if (window.google && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
          client_id: clientID,
          callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
          document.getElementById("signinBtn"),
          { theme: "outline", size: "large", type: "standard", shape: "pill" }
        );
      }
      document.getElementById("dataForm").addEventListener("submit", onSubmit);
      autoDetectLocation();
    };
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch {
        return {};
      }
    }
function handleCredentialResponse(response) {
  const payload = parseJwt(response.credential);
  const email = payload.email || "";
  if (allowedEmails.includes(email)) {
    // save session for 1 hr
    localStorage.setItem("userSession", JSON.stringify({
      email: email,
      timestamp: Date.now()
    }));
    document.querySelector('[name="email"]').value = email;
    document.getElementById("whoami").innerHTML = `Fiber line marking`;
    document.getElementById("deniedMsg").classList.add("hidden");
    document.getElementById("signinCard").classList.add("hidden");
    document.getElementById("formCard").classList.remove("hidden");
    initializeForm();
  } else {
    document.getElementById("deniedMsg").classList.remove("hidden");
  }
}
    function autoDetectLocation() {
      if (!navigator.geolocation) {
        document.getElementById("locationRow").classList.remove("hidden");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          document.querySelector("[name=locationLink]").value =
            `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        },
        () => document.getElementById("locationRow").classList.remove("hidden"),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
    function compressImageToDataURL(file, maxKB = 200) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("Failed to read file"));
        reader.onload = () => {
          const img = new Image();
          img.onerror = () => reject(new Error("Invalid image"));
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const scale = Math.min(1, Math.sqrt((maxKB * 1024) / (file.size || (img.width * img.height))));
            canvas.width = Math.max(1, Math.round(img.width * scale));
            canvas.height = Math.max(1, Math.round(img.height * scale));
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            let quality = 0.75;
            let dataUrl = canvas.toDataURL("image/jpeg", quality);
            while (dataUrl.length / 1024 > maxKB && quality > 0.2) {
              quality -= 0.05;
              dataUrl = canvas.toDataURL("image/jpeg", quality);
            }
            resolve(dataUrl);
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }
    async function onSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const overlay = document.createElement("div");
      overlay.className = "spinner-overlay";
      overlay.innerHTML = '<div class="spinner"></div><div class="spinner-text">Submitting...</div>';
      document.body.appendChild(overlay);
      const p1 = form.photo1.files[0];
      const p2 = form.photo2.files[0];
      if (!p1 || !p2) {
        document.querySelector(".spinner-overlay")?.remove();
        showToast("‚ùå Both JC Photo and Area Photo are required", "error");
        return;
      }
      let photos;
      try {
        photos = [await compressImageToDataURL(p1, 200), await compressImageToDataURL(p2, 200)];
      } catch (err) {
        document.querySelector(".spinner-overlay")?.remove();
        showToast("‚ùå Image processing failed: " + err.message, "error");
        return;
      }
      const payload = {
        email: form.email.value,
        locationLink: form.locationLink.value,
        photos,
        jcname: form.jcname.value,
        splitter: form.splitter.value,
        wire: form.wire.value,
        wirecolor: form.wirecolor.value,
        linename: form.linename.value,
        drumno: form.drumno.value,
        remark: form.remark.value,
        vacantcores: form.vacantcores.value,
        windowoption: form.windowoption.value,
        startTime: form.startTime.value
      };
      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(resp => {
        document.querySelector(".spinner-overlay")?.remove();
        if (resp.status === "success") {
          showToast("‚úÖ Tagging submitted successfully!", "success");
          clearStoredData();
          setTimeout(() => window.location.reload(), 2000);
        } else {
          showToast("‚ùå " + (resp.message || "Server error"), "error");
        }
      })
      .catch(err => {
        document.querySelector(".spinner-overlay")?.remove();
        showToast("‚ùå Network error: " + err, "error");
      });
    }
    function showToast(text, type) {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = text;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("fade-out");
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }
    function startTagging() {
      const submitBtn = document.getElementById('submitBtn');
      const startTimeField = document.querySelector('[name="startTime"]');
      const countdownEl = document.getElementById('countdown');
      const startBtn = document.getElementById('startTaggingBtn');
      const now = Date.now();
      localStorage.setItem('startTime', now);
      startTimeField.value = new Date(now).toISOString();
      startBtn.disabled = true;
      lastRemaining = null;
      updateCountdown();
      showToast("üïí Please wait 600 seconds before submitting.", "info");
    }
    function updateCountdown() {
      const start = parseInt(localStorage.getItem('startTime') || 0);
      const submitBtn = document.getElementById('submitBtn');
      const countdownEl = document.getElementById('countdown');
      const startBtn = document.getElementById('startTaggingBtn');
      if (start === 0) return;
      const elapsed = Date.now() - start;
      let remaining = COUNTDOWN_DURATION - Math.floor(elapsed / 1000);
      if (remaining < 0) remaining = 0;
      countdownEl.textContent = remaining > 0 ? `(${remaining}s)` : '';
      submitBtn.disabled = remaining > 0;
      startBtn.disabled = true;
      if (remaining === 0 && lastRemaining > 0) {
        showToast("‚úÖ You can now submit the form.", "success");
      }
      lastRemaining = remaining;
    }
    async function loadFormData() {
      const data = JSON.parse(localStorage.getItem('formData')) || {};
      const form = document.getElementById('dataForm');
      fieldsToSave.forEach(field => {
        if (data[field]) {
          form[field].value = data[field];
        }
      });
      const start = localStorage.getItem('startTime');
      if (start) {
        form.startTime.value = new Date(parseInt(start)).toISOString();
        document.getElementById('startTaggingBtn').disabled = true;
      }
      await loadPhoto('photo1');
      await loadPhoto('photo2');
    }
    function saveFormData() {
      const form = document.getElementById('dataForm');
      const data = {};
      fieldsToSave.forEach(field => {
        data[field] = form[field].value;
      });
      localStorage.setItem('formData', JSON.stringify(data));
    }
    async function loadPhoto(name) {
      const base64 = localStorage.getItem(name);
      if (base64) {
        try {
          const response = await fetch(base64);
          const blob = await response.blob();
          const file = new File([blob], `${name}.jpg`, {type: 'image/jpeg'});
          const input = document.querySelector(`[name="${name}"]`);
          const dt = new DataTransfer();
          dt.items.add(file);
          input.files = dt.files;
        } catch (err) {
          console.error('Failed to load photo:', err);
        }
      }
    }
    function savePhoto(e) {
      const input = e.target;
      const file = input.files[0];
      if (file) {
        compressImageToDataURL(file, 200).then(dataUrl => {
          localStorage.setItem(input.name, dataUrl);
        }).catch(err => {
          console.error('Failed to save photo:', err);
        });
      }
    }
    function clearStoredData() {
      localStorage.removeItem('formData');
      localStorage.removeItem('startTime');
      localStorage.removeItem('photo1');
      localStorage.removeItem('photo2');
      clearInterval(timerInterval);
      document.getElementById('startTaggingBtn').disabled = false;
    }
    function initializeForm() {
      document.getElementById("whoami").innerHTML = `Fiber line marking`;
      loadFormData();
      fieldsToSave.forEach(field => {
        const elem = document.querySelector(`[name="${field}"]`);
        elem.addEventListener('change', saveFormData);
        elem.addEventListener('input', saveFormData);
      });
      document.querySelector('[name="photo1"]').addEventListener('change', savePhoto);
      document.querySelector('[name="photo2"]').addEventListener('change', savePhoto);
      timerInterval = setInterval(updateCountdown, 1000);
      updateCountdown(); // initial call
    }
    function resetTag() {
      // Show modal instead of confirm box
      document.getElementById("resetModal").style.display = "flex";
      // Handle confirm
      document.getElementById("confirmResetBtn").onclick = function () {
        const email = localStorage.getItem("userSession"); // preserve session
        localStorage.removeItem('formData');
        localStorage.removeItem('startTime');
        localStorage.removeItem('photo1');
        localStorage.removeItem('photo2');
        clearInterval(timerInterval);
        document.getElementById('dataForm').reset();
        document.getElementById('startTaggingBtn').disabled = false;
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('countdown').textContent = '';
        document.getElementById("resetModal").style.display = "none"; // close modal
        showToast("üîÑ Tag has been reset. You can start fresh.", "info");
      };
      // Handle cancel
      document.getElementById("cancelResetBtn").onclick = function () {
        document.getElementById("resetModal").style.display = "none";
      };
    }
  </script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const loginCard = document.getElementById("signinCard");
  const formCard = document.getElementById("formCard");
  const emailInput = document.querySelector("input[name='email']");
  const ONE_HOUR = 60 * 60 * 1000; // 1 hour in milliseconds
  // Check saved email in localStorage
  const savedSession = JSON.parse(localStorage.getItem("userSession"));
  if (savedSession) {
    const now = Date.now();
    if (now - savedSession.timestamp < ONE_HOUR) {
      // Session is still valid
      emailInput.value = savedSession.email; // auto-fill email
      loginCard.classList.add("hidden");
      formCard.classList.remove("hidden");
      initializeForm();
      console.log("Auto-login with saved email:", savedSession.email);
    } else {
      // Session expired
      localStorage.removeItem("userSession");
    }
  }

// Function to mark selected image input
function handleFileSelectForHighlight(e) {
  const input = e.target;
  if (input.files && input.files.length > 0) {
    input.classList.add("selected");  // green highlight
  } else {
    input.classList.remove("selected");
  }
}

// Apply listeners on photo inputs
document.querySelector('[name="photo1"]').addEventListener('change', handleFileSelectForHighlight);
document.querySelector('[name="photo2"]').addEventListener('change', handleFileSelectForHighlight);


  
});
</script>
</body>
</html>
</xaiArtifact>
