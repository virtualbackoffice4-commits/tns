<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rack</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Preparing ...</p>
</div>

<!-- TABLE -->
<div id="matrixHolder">
<table id="matrixTable">

<tr>
  <th></th>
  <th></th>
  <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
  <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
  <th>Total</th>
</tr>

<!-- TSN WINDOW -->
<tr class="separator">
  <th colspan="11">TSN Window</th>
</tr>

<!-- ================= O1I5 ================= -->
<tr>
  <th rowspan="4" class="olt-name">O1I5</th>
  <th>Users</th>
  <td id="pon1-O1I5" class="clickable">‚è≥</td>
  <td id="pon2-O1I5" class="clickable">‚è≥</td>
  <td id="pon3-O1I5" class="clickable">‚è≥</td>
  <td id="pon4-O1I5" class="clickable">‚è≥</td>
  <td id="pon5-O1I5" class="clickable">‚è≥</td>
  <td id="pon6-O1I5" class="clickable">‚è≥</td>
  <td id="pon7-O1I5" class="clickable">‚è≥</td>
  <td id="pon8-O1I5" class="clickable">‚è≥</td>
  <td id="oltTotal-O1I5" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O1I5" class="clickable">‚è≥</td>
  <td id="off2-O1I5" class="clickable">‚è≥</td>
  <td id="off3-O1I5" class="clickable">‚è≥</td>
  <td id="off4-O1I5" class="clickable">‚è≥</td>
  <td id="off5-O1I5" class="clickable">‚è≥</td>
  <td id="off6-O1I5" class="clickable">‚è≥</td>
  <td id="off7-O1I5" class="clickable">‚è≥</td>
  <td id="off8-O1I5" class="clickable">‚è≥</td>
  <td id="oltOffTotal-O1I5" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O1I5" class="clickable">‚è≥</td>
  <td id="tick2-O1I5" class="clickable">‚è≥</td>
  <td id="tick3-O1I5" class="clickable">‚è≥</td>
  <td id="tick4-O1I5" class="clickable">‚è≥</td>
  <td id="tick5-O1I5" class="clickable">‚è≥</td>
  <td id="tick6-O1I5" class="clickable">‚è≥</td>
  <td id="tick7-O1I5" class="clickable">‚è≥</td>
  <td id="tick8-O1I5" class="clickable">‚è≥</td>
  <td id="oltTickTotal-O1I5" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O1I5">‚è≥</td>
  <td id="stat2-O1I5">‚è≥</td>
  <td id="stat3-O1I5">‚è≥</td>
  <td id="stat4-O1I5">‚è≥</td>
  <td id="stat5-O1I5">‚è≥</td>
  <td id="stat6-O1I5">‚è≥</td>
  <td id="stat7-O1I5">‚è≥</td>
  <td id="stat8-O1I5">‚è≥</td>
  <td></td>
</tr>

<!-- ================= O2I6 ================= -->
<tr>
  <th rowspan="4" class="olt-name">O2I6</th>
  <th>Users</th>
  <td id="pon1-O2I6" class="clickable">‚è≥</td>
  <td id="pon2-O2I6" class="clickable">‚è≥</td>
  <td id="pon3-O2I6" class="clickable">‚è≥</td>
  <td id="pon4-O2I6" class="clickable">‚è≥</td>
  <td id="pon5-O2I6" class="clickable">‚è≥</td>
  <td id="pon6-O2I6" class="clickable">‚è≥</td>
  <td id="pon7-O2I6" class="clickable">‚è≥</td>
  <td id="pon8-O2I6" class="clickable">‚è≥</td>
  <td id="oltTotal-O2I6" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O2I6" class="clickable">‚è≥</td>
  <td id="off2-O2I6" class="clickable">‚è≥</td>
  <td id="off3-O2I6" class="clickable">‚è≥</td>
  <td id="off4-O2I6" class="clickable">‚è≥</td>
  <td id="off5-O2I6" class="clickable">‚è≥</td>
  <td id="off6-O2I6" class="clickable">‚è≥</td>
  <td id="off7-O2I6" class="clickable">‚è≥</td>
  <td id="off8-O2I6" class="clickable">‚è≥</td>
  <td id="oltOffTotal-O2I6" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O2I6" class="clickable">‚è≥</td>
  <td id="tick2-O2I6" class="clickable">‚è≥</td>
  <td id="tick3-O2I6" class="clickable">‚è≥</td>
  <td id="tick4-O2I6" class="clickable">‚è≥</td>
  <td id="tick5-O2I6" class="clickable">‚è≥</td>
  <td id="tick6-O2I6" class="clickable">‚è≥</td>
  <td id="tick7-O2I6" class="clickable">‚è≥</td>
  <td id="tick8-O2I6" class="clickable">‚è≥</td>
  <td id="oltTickTotal-O2I6" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O2I6">‚è≥</td>
  <td id="stat2-O2I6">‚è≥</td>
  <td id="stat3-O2I6">‚è≥</td>
  <td id="stat4-O2I6">‚è≥</td>
  <td id="stat5-O2I6">‚è≥</td>
  <td id="stat6-O2I6">‚è≥</td>
  <td id="stat7-O2I6">‚è≥</td>
  <td id="stat8-O2I6">‚è≥</td>
  <td></td>
</tr>

<!-- ================= O3I7 ================= -->
<tr>
  <th rowspan="4" class="olt-name">O3I7</th>
  <th>Users</th>
  <td id="pon1-O3I7" class="clickable">‚è≥</td>
  <td id="pon2-O3I7" class="clickable">‚è≥</td>
  <td id="pon3-O3I7" class="clickable">‚è≥</td>
  <td id="pon4-O3I7" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltTotal-O3I7" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O3I7" class="clickable">‚è≥</td>
  <td id="off2-O3I7" class="clickable">‚è≥</td>
  <td id="off3-O3I7" class="clickable">‚è≥</td>
  <td id="off4-O3I7" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltOffTotal-O3I7" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O3I7" class="clickable">‚è≥</td>
  <td id="tick2-O3I7" class="clickable">‚è≥</td>
  <td id="tick3-O3I7" class="clickable">‚è≥</td>
  <td id="tick4-O3I7" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltTickTotal-O3I7" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O3I7">‚è≥</td>
  <td id="stat2-O3I7">‚è≥</td>
  <td id="stat3-O3I7">‚è≥</td>
  <td id="stat4-O3I7">‚è≥</td>
  <td colspan="4"></td>
  <td></td>
</tr>

</table>
</div>

<!-- ================= JS ================= -->
<script>
const WEB_APP_URL =
  'https://script.google.com/macros/s/AKfycbwS-PswDc7EbyqRWn-vxfZymz6CGeUiZOByY5Dgq0HruWRGxamZXd-_CgdHnmR3vYKsFg/exec';

const TOKEN = 'abcd1234';
const STATUS_LINK = 'https://vbo.co.in/ISP/Lucknow/Merotra/tag';

const OLTS = [
  { id: 'O1I5', pons: 8 },
  { id: 'O2I6', pons: 8 },
  { id: 'O3I7', pons: 4 }
];

let oltData = {};
let dashboardA7 = null;

async function loadData() {

  // init
  OLTS.forEach(o => {
    for (let i = 1; i <= o.pons; i++) {
      oltData[o.id + 'P' + i] = { all: [], off: [], tick: [], drops: [] };
    }
  });

  try {
    const res = await fetch(WEB_APP_URL + '?token=' + encodeURIComponent(TOKEN));
    const data = await res.json();

    const rows = data.rows || [];
    dashboardA7 = data.dashboardA7;

    OLTS.forEach(o => {
      let total = 0, offTotal = 0, tickTotal = 0;

      for (let i = 1; i <= o.pons; i++) {
        const nmid = o.id + 'P' + i;

        const filtered = rows.filter(r =>
          (r['NMID'] || '').trim().toUpperCase() === nmid &&
          (r['Users'] || r['Users'] === 0)
        );

        const offRows = filtered.filter(r => r['Downs']);
        const tickRows = filtered.filter(r => r['Ticket']);
        const dropTimes = filtered.map(r => r['Drops']).filter(Boolean);

        oltData[nmid] = { all: filtered, off: offRows, tick: tickRows, drops: dropTimes };

        document.getElementById(`pon${i}-${o.id}`).textContent = filtered.length || '';
        document.getElementById(`off${i}-${o.id}`).textContent = offRows.length || '';
        document.getElementById(`tick${i}-${o.id}`).textContent = tickRows.length || '';

        const stat = document.getElementById(`stat${i}-${o.id}`);
        if (dashboardA7 !== null) {
          const isOn = dropTimes.length < dashboardA7;
          stat.innerHTML = `<a href="${STATUS_LINK}">${isOn ? 'üü¢' : 'üî¥'}</a>`;
        }
        total += filtered.length;
        offTotal += offRows.length;
        tickTotal += tickRows.length;
      }

      document.getElementById(`oltTotal-${o.id}`).textContent = total || '';
      document.getElementById(`oltOffTotal-${o.id}`).textContent = offTotal || '';
      document.getElementById(`oltTickTotal-${o.id}`).textContent = tickTotal || '';
    });

    document.getElementById('loadingOverlay').style.display = 'none';

  } catch (err) {
    console.error(err);
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}

window.addEventListener('load', () => {
  loadData();
  setInterval(loadData, 30000);
});
</script>

</body>
</html>
