<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rack</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Prepairing ...</p>
</div>

<div id="matrixHolder">
<table id="matrixTable">

<tr>
  <th></th><th></th>
  <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
  <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
  <th>Total</th>
</tr>

<tr class="separator">
  <th colspan="11">TSN Window</th>
</tr>

<!-- ================= O1I2 ================= -->
<tr>
  <th rowspan="4" class="olt-name">O1I2</th>
  <th>Users</th>
  <td id="pon1-O1I2" class="clickable">‚è≥</td>
  <td id="pon2-O1I2" class="clickable">‚è≥</td>
  <td id="pon3-O1I2" class="clickable">‚è≥</td>
  <td id="pon4-O1I2" class="clickable">‚è≥</td>
  <td id="pon5-O1I2" class="clickable">‚è≥</td>
  <td id="pon6-O1I2" class="clickable">‚è≥</td>
  <td id="pon7-O1I2" class="clickable">‚è≥</td>
  <td id="pon8-O1I2" class="clickable">‚è≥</td>
  <td id="oltTotal-O1I2" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O1I2" class="clickable">‚è≥</td>
  <td id="off2-O1I2" class="clickable">‚è≥</td>
  <td id="off3-O1I2" class="clickable">‚è≥</td>
  <td id="off4-O1I2" class="clickable">‚è≥</td>
  <td id="off5-O1I2" class="clickable">‚è≥</td>
  <td id="off6-O1I2" class="clickable">‚è≥</td>
  <td id="off7-O1I2" class="clickable">‚è≥</td>
  <td id="off8-O1I2" class="clickable">‚è≥</td>
  <td id="oltOffTotal-O1I2" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O1I2" class="clickable">‚è≥</td>
  <td id="tick2-O1I2" class="clickable">‚è≥</td>
  <td id="tick3-O1I2" class="clickable">‚è≥</td>
  <td id="tick4-O1I2" class="clickable">‚è≥</td>
  <td id="tick5-O1I2" class="clickable">‚è≥</td>
  <td id="tick6-O1I2" class="clickable">‚è≥</td>
  <td id="tick7-O1I2" class="clickable">‚è≥</td>
  <td id="tick8-O1I2" class="clickable">‚è≥</td>
  <td id="oltTickTotal-O1I2" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O1I2">‚è≥</td>
  <td id="stat2-O1I2">‚è≥</td>
  <td id="stat3-O1I2">‚è≥</td>
  <td id="stat4-O1I2">‚è≥</td>
  <td id="stat5-O1I2">‚è≥</td>
  <td id="stat6-O1I2">‚è≥</td>
  <td id="stat7-O1I2">‚è≥</td>
  <td id="stat8-O1I2">‚è≥</td>
  <td></td>
</tr>

<!-- ================= O2I3 ================= -->
<tr>
  <th rowspan="4" class="olt-name">O2I3</th>
  <th>Users</th>
  <td id="pon1-O2I3" class="clickable">‚è≥</td>
  <td id="pon2-O2I3" class="clickable">‚è≥</td>
  <td id="pon3-O2I3" class="clickable">‚è≥</td>
  <td id="pon4-O2I3" class="clickable">‚è≥</td>
  <td id="pon5-O2I3" class="clickable">‚è≥</td>
  <td id="pon6-O2I3" class="clickable">‚è≥</td>
  <td id="pon7-O2I3" class="clickable">‚è≥</td>
  <td id="pon8-O2I3" class="clickable">‚è≥</td>
  <td id="oltTotal-O2I3" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O2I3" class="clickable">‚è≥</td>
  <td id="off2-O2I3" class="clickable">‚è≥</td>
  <td id="off3-O2I3" class="clickable">‚è≥</td>
  <td id="off4-O2I3" class="clickable">‚è≥</td>
  <td id="off5-O2I3" class="clickable">‚è≥</td>
  <td id="off6-O2I3" class="clickable">‚è≥</td>
  <td id="off7-O2I3" class="clickable">‚è≥</td>
  <td id="off8-O2I3" class="clickable">‚è≥</td>
  <td id="oltOffTotal-O2I3" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O2I3" class="clickable">‚è≥</td>
  <td id="tick2-O2I3" class="clickable">‚è≥</td>
  <td id="tick3-O2I3" class="clickable">‚è≥</td>
  <td id="tick4-O2I3" class="clickable">‚è≥</td>
  <td id="tick5-O2I3" class="clickable">‚è≥</td>
  <td id="tick6-O2I3" class="clickable">‚è≥</td>
  <td id="tick7-O2I3" class="clickable">‚è≥</td>
  <td id="tick8-O2I3" class="clickable">‚è≥</td>
  <td id="oltTickTotal-O2I3" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O2I3">‚è≥</td>
  <td id="stat2-O2I3">‚è≥</td>
  <td id="stat3-O2I3">‚è≥</td>
  <td id="stat4-O2I3">‚è≥</td>
  <td id="stat5-O2I3">‚è≥</td>
  <td id="stat6-O2I3">‚è≥</td>
  <td id="stat7-O2I3">‚è≥</td>
  <td id="stat8-O2I3">‚è≥</td>
  <td></td>
</tr>

</table>
</div>

<!-- MODAL -->
<div id="userModal">
  <div id="userModalContent">
    <span class="closeBtn" onclick="closeModal()">&times;</span>
    <div id="modalButtons"></div>
    <div id="screenshotContent">
      <h3 id="modalTitle"></h3>
      <div id="modalSubTitle"></div>
      <div id="userDetails"></div>
    </div>
  </div>
</div>

<div id="toast">No user in list!!</div>

<script>
/* ================= CONFIG ================= */
const WEB_APP_URLS = [
  'https://script.google.com/macros/s/AKfycbwS-PswDc7EbyqRWn-vxfZymz6CGeUiZOByY5Dgq0HruWRGxamZXd-_CgdHnmR3vYKsFg/exec'
];
const TOKEN = 'abcd1234';
const STATUS_LINK = 'https://vbo.co.in/ISP/Lucknow/Merotra/tag';

let oltData = {};
let dashboardA7 = null;

/* ================= LOAD DATA ================= */
async function loadData() {

  const olts = [
    { id: 'O1I2', pons: 8 },
    { id: 'O2I3', pons: 8 }
  ];

  oltData = {};
  olts.forEach(o=>{
    for(let i=1;i<=o.pons;i++){
      oltData[o.id+'P'+i] = { all:[], off:[], tick:[], drops:[] };
    }
  });

  try {
    const res = await fetch(WEB_APP_URLS[0]+'?token='+TOKEN);
    const data = await res.json();
    dashboardA7 = data.dashboardA7 ?? null;
    const rows = data.rows || [];

    olts.forEach(o=>{
      let total=0, offTotal=0, tickTotal=0;

      for(let i=1;i<=o.pons;i++){
        const nmid = o.id+'P'+i;
        const filtered = rows.filter(r =>
          (r.NMID||'').trim().toUpperCase()===nmid &&
          (r.Users || r.Users===0)
        );

        const off = filtered.filter(r=>r.Downs);
        const tick = filtered.filter(r=>r.Ticket);
        const drops = filtered.map(r=>r.Drops).filter(Boolean);

        oltData[nmid]={all:filtered, off, tick, drops};

        document.getElementById(`pon${i}-${o.id}`).textContent = filtered.length || '';
        document.getElementById(`off${i}-${o.id}`).textContent = off.length || '';
        document.getElementById(`tick${i}-${o.id}`).textContent = tick.length || '';

        const stat=document.getElementById(`stat${i}-${o.id}`);
        if(dashboardA7!==null){
          const isOn = drops.length < dashboardA7;
          stat.innerHTML=`<a href="${STATUS_LINK}" target="_self">${isOn?'üü¢':'üî¥'}</a>`;
        }

        total+=filtered.length;
        offTotal+=off.length;
        tickTotal+=tick.length;
      }

      document.getElementById(`oltTotal-${o.id}`).textContent = total || '';
      document.getElementById(`oltOffTotal-${o.id}`).textContent = offTotal || '';
      document.getElementById(`oltTickTotal-${o.id}`).textContent = tickTotal || '';
    });

    attachEventListeners();
    document.getElementById('loadingOverlay').style.display='none';

  } catch(e){
    console.error(e);
    document.getElementById('loadingOverlay').style.display='none';
  }
}

/* ================= ORIGINAL FUNCTIONS ================= */

function showToast(){
  const t=document.getElementById('toast');
  t.className='show';
  setTimeout(()=>t.className='',3000);
}

function attachEventListeners(){
  const olts=[
    {id:'O1I2',pons:8},
    {id:'O2I3',pons:8}
  ];

  olts.forEach(o=>{
    for(let i=1;i<=o.pons;i++){
      ['pon','off','tick'].forEach(type=>{
        const el=document.getElementById(`${type}${i}-${o.id}`);
        if(el){
          el.onclick=()=>{
            if(el.textContent===''||el.textContent==='0') showToast();
            else showUsers(type==='pon'?'all':type, o.id+'P'+i, o.id, 'P'+i);
          };
        }
      });
    }

    ['Total','OffTotal','TickTotal'].forEach(t=>{
      const el=document.getElementById(`olt${t}-${o.id}`);
      if(el){
        el.onclick=()=>{
          if(el.textContent===''||el.textContent==='0') showToast();
          else showOltUsers(t==='Total'?'all':t==='OffTotal'?'off':'tick', o.id, o.pons);
        };
      }
    });
  });
}

/* ==== showUsers & showOltUsers = EXACT ORIGINAL (CSV + Screenshot INCLUDED) ==== */

<!-- (same as your original; intentionally unchanged) -->

function closeModal(){
  document.getElementById('userModal').style.display='none';
}

window.addEventListener('load',()=>{
  loadData();
  setInterval(loadData,30000);
});
</script>

</body>
</html>
